# 运维手册 (Runbook)

> **模板版本**: v1.0.0 | **最后更新**: 2025-10-31

## 1. 文档信息
- **项目名称**: [项目名称]
- **服务名称**: [服务名称]
- **文档版本**: v1.0
- **创建日期**: [YYYY-MM-DD]
- **维护人**: [姓名]
- **紧急联系人**: [姓名] - [电话]

---

## 2. 服务概览

### 2.1 服务描述
[简要描述服务的功能和作用]

### 2.2 服务架构
[架构图或简要描述]

### 2.3 关键指标
- **可用性目标**: 99.9%
- **响应时间**: P95 < 200ms
- **吞吐量**: > 1000 QPS

---

## 3. 部署信息

### 3.1 环境信息
| 环境 | 服务地址 | 数据库 | 缓存 | 负责人 |
|------|---------|--------|------|--------|
| 生产环境 | [URL] | [地址] | [地址] | [姓名] |
| 预发布环境 | [URL] | [地址] | [地址] | [姓名] |

### 3.2 部署架构
```
[负载均衡] → [Web服务器集群] → [应用服务器] → [数据库]
```

### 3.3 资源配置
- **CPU**: [核心数]
- **内存**: [容量]
- **磁盘**: [容量]
- **网络**: [带宽]

---

## 4. 启动与停止

### 4.1 启动服务
```bash
# 启动命令
./start.sh

# 验证服务状态
curl http://localhost:8080/health

# 查看日志
tail -f logs/app.log
```

### 4.2 停止服务
```bash
# 优雅停止
./stop.sh

# 强制停止（紧急情况）
kill -9 $(cat app.pid)
```

### 4.3 重启服务
```bash
./restart.sh
```

---

## 5. 监控与告警

### 5.1 监控面板
- **Grafana Dashboard**: [链接]
- **APM 平台**: [链接]
- **日志平台**: [链接]

### 5.2 关键监控指标
| 指标 | 告警阈值 | 处理优先级 |
|------|---------|-----------|
| CPU 使用率 | > 80% | P2 |
| 内存使用率 | > 85% | P2 |
| 磁盘使用率 | > 90% | P1 |
| 响应时间 P95 | > 500ms | P1 |
| 错误率 | > 1% | P0 |
| 可用性 | < 99% | P0 |

### 5.3 告警渠道
- **钉钉群**: [群名称]
- **邮件**: [邮箱]
- **电话**: [on-call 电话]

---

## 6. 常见问题排查

### 6.1 服务不可用

**症状**: 健康检查失败，服务无响应

**排查步骤**:
1. 检查服务进程是否运行
   ```bash
   ps aux | grep [service-name]
   ```
2. 检查端口是否监听
   ```bash
   netstat -tlnp | grep [port]
   ```
3. 查看错误日志
   ```bash
   tail -n 100 logs/error.log
   ```
4. 检查系统资源
   ```bash
   top
   df -h
   ```

**解决方案**:
- 如果进程崩溃，重启服务
- 如果资源不足，扩容或清理

---

### 6.2 响应时间慢

**症状**: API 响应时间超过阈值

**排查步骤**:
1. 查看 APM 链路追踪
2. 检查数据库慢查询
   ```sql
   SHOW PROCESSLIST;
   ```
3. 检查缓存命中率
4. 检查网络延迟

**解决方案**:
- 优化慢查询
- 增加缓存
- 扩容服务器

---

### 6.3 内存泄漏

**症状**: 内存持续增长，最终 OOM

**排查步骤**:
1. 查看内存使用趋势
2. 生成 heap dump
   ```bash
   jmap -dump:live,format=b,file=heap.bin [pid]
   ```
3. 分析 heap dump

**解决方案**:
- 修复内存泄漏代码
- 临时方案：定期重启服务

---

### 6.4 数据库连接耗尽

**症状**: "Too many connections" 错误

**排查步骤**:
1. 查看当前连接数
   ```sql
   SHOW STATUS LIKE 'Threads_connected';
   ```
2. 查看连接来源
   ```sql
   SELECT * FROM INFORMATION_SCHEMA.PROCESSLIST;
   ```

**解决方案**:
- 关闭空闲连接
- 增加最大连接数
- 优化连接池配置

---

## 7. 应急响应

### 7.1 故障等级
- **P0**: 服务完全不可用，影响所有用户
- **P1**: 核心功能不可用，影响大量用户
- **P2**: 部分功能异常，影响少量用户
- **P3**: 性能下降，用户有感知

### 7.2 应急流程
1. **发现问题** → 监控告警或用户反馈
2. **评估影响** → 判断故障等级
3. **组建团队** → 召集相关人员
4. **快速止损** → 回滚/降级/扩容
5. **根因分析** → 定位根本原因
6. **修复验证** → 修复并验证
7. **复盘总结** → 编写事故报告

### 7.3 应急预案

#### 方案1: 回滚
```bash
# 回滚到上一个版本
./rollback.sh [version]

# 验证回滚结果
curl http://localhost:8080/version
```

#### 方案2: 降级
```bash
# 开启降级开关
curl -X POST http://localhost:8080/admin/degrade \
  -H "Content-Type: application/json" \
  -d '{"feature": "non-critical-feature", "enabled": false}'
```

#### 方案3: 限流
```bash
# 调整限流阈值
curl -X POST http://localhost:8080/admin/rate-limit \
  -H "Content-Type: application/json" \
  -d '{"limit": 500}'
```

---

## 8. 日常运维

### 8.1 日志管理
**日志位置**: `/var/log/[service-name]/`

**日志清理**:
```bash
# 清理7天前的日志
find /var/log/[service-name]/ -name "*.log" -mtime +7 -delete
```

**日志分析**:
```bash
# 统计错误数量
grep "ERROR" app.log | wc -l

# 查看最近的错误
grep "ERROR" app.log | tail -n 20
```

### 8.2 数据备份
**备份策略**:
- 全量备份：每天凌晨3点
- 增量备份：每小时一次

**备份命令**:
```bash
# 数据库备份
mysqldump -u root -p [database] > backup_$(date +%Y%m%d).sql

# 验证备份
mysql -u root -p [database] < backup_20251031.sql
```

### 8.3 定期检查
**每日检查**:
- [ ] 服务健康状态
- [ ] 关键指标是否正常
- [ ] 磁盘空间是否充足

**每周检查**:
- [ ] 备份是否成功
- [ ] 慢查询是否增多
- [ ] 告警是否异常

**每月检查**:
- [ ] 依赖库是否需要更新
- [ ] SSL 证书是否即将过期
- [ ] 资源使用趋势

---

## 9. 发布流程

### 9.1 发布前检查
- [ ] 代码已合并到主分支
- [ ] 测试环境验证通过
- [ ] 数据库迁移脚本已准备
- [ ] 回滚方案已确认
- [ ] 通知用户（如需要）

### 9.2 发布步骤
1. 备份当前版本
2. 更新代码
3. 执行数据库迁移
4. 重启服务
5. 健康检查
6. 监控观察（30分钟）

### 9.3 发布后验证
- [ ] 服务启动成功
- [ ] 关键接口正常
- [ ] 监控指标正常
- [ ] 无错误日志

---

## 10. 联系人

### 10.1 团队联系方式
| 角色 | 姓名 | 电话 | 邮箱 | 负责范围 |
|------|------|------|------|---------|
| 技术负责人 | | | | 整体架构 |
| 后端负责人 | | | | 后端服务 |
| 运维负责人 | | | | 基础设施 |
| On-Call | | | | 应急响应 |

### 10.2 外部依赖联系方式
| 服务 | 联系人 | 电话 | 紧急处理 |
|------|--------|------|---------|
| [外部服务1] | | | |

---

## 11. 附录

### 11.1 常用命令
```bash
# 查看服务状态
systemctl status [service-name]

# 查看实时日志
tail -f /var/log/[service]/app.log

# 查看端口占用
lsof -i :[port]

# 查看进程
ps aux | grep [service]
```

### 11.2 相关文档
- 技术设计文档: [链接]
- API 文档: [链接]
- 部署文档: [链接]

### 11.3 变更记录
| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|---------|
| v1.0 | [日期] | [姓名] | 初始版本 |
